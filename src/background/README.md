# 后台服务工作线程 (Background Service Worker)

后台服务工作线程是英语阅读助手扩展的核心，协调所有操作并管理不同组件之间的通信。

## 架构设计

后台工作线程采用模块化组织：

### 主要组件

1. **index.ts** - 主要服务工作线程入口
   - 初始化所有处理器和监听器
   - 设置上下文菜单和键盘快捷键
   - 管理安装和更新事件

2. **messageHandler.ts** - 消息处理
   - 处理来自内容脚本和 UI 的所有消息
   - 处理翻译请求
   - 管理词汇和设置操作
   - 批量更新单词以提升性能

3. **alarmHandler.ts** - 定时任务
   - 每日统计重置（午夜）
   - 缓存清理（每小时）
   - 统计数据清理（每天）
   - 备份提醒（每周）

## 消息类型

服务工作线程处理以下消息类型：

### 翻译与内容
- `TRANSLATE_TEXT` - 翻译选中的文本
- `EXTRACT_TEXT` - 处理从页面提取的文本
- `BATCH_WORD_UPDATE` - 批量更新单词统计

### 词汇管理
- `SAVE_VOCABULARY` - 添加单词到词汇集合

### 设置
- `GET_SETTINGS` - 获取当前设置
- `UPDATE_SETTINGS` - 更新设置并广播到所有标签页

### UI 控制
- `OPEN_SIDE_PANEL` - 打开翻译侧边栏
- `GET_SELECTION` - 请求当前文本选择

## 功能特性

### 上下文菜单集成
- 右键点击选中文本进行翻译
- 自动打开侧边栏显示结果

### 键盘快捷键
- `Ctrl+Shift+T` (Windows/Linux) / `Cmd+Shift+T` (Mac)
- 立即翻译当前选中内容

### 定时任务

#### 每小时任务
- 清理过期的翻译缓存
- 维护缓存大小限制（最多 1000 条）

#### 每日任务（午夜）
- 初始化新的每日统计条目
- 清理旧统计数据（>90 天）
- 记录前一天的阅读活动

#### 每周任务（周日）
- 发送备份提醒通知
- 鼓励导出词汇

### 安装与更新

#### 首次安装
- 初始化默认设置
- 显示欢迎通知
- 打开选项页面配置 API

#### 更新
- 执行必要的迁移任务
- 记录版本变更

## 性能优化

### 批处理
- 单词更新以 50 个为一批处理
- 防止大文本分析时阻塞

### 高效缓存
- 翻译结果缓存在 IndexedDB
- 自动清理过期/旧条目
- 基于大小的驱逐策略（LRU）

### 错误处理
- 失败时优雅降级
- 详细日志记录用于调试
- 用户友好的错误消息

### 消息广播
- 设置更新广播到所有标签页
- 确保扩展行为一致

## 数据流

### 翻译请求流程
```
内容脚本 → 后台 → 翻译服务 → 缓存/API
            ↓
        侧边栏（显示结果）
            ↓
        统计更新（IndexedDB）
```

### 文本分析流程
```
内容脚本 → 文本提取 → 后台 → 单词处理
                            ↓
                        批量更新 → IndexedDB
                            ↓
                        统计聚合
```

### 设置流程
```
选项页面 → 后台 → chrome.storage.local
              ↓
        广播到所有标签页 → 内容脚本
```

## 安全与隐私

### 数据处理
- 只有选中的文本会发送到翻译 API
- 完整页面内容保留在本地
- API 凭据存储在 chrome.storage.local

### 权限
- 最小化权限请求
- 无外部追踪或分析
- 所有数据本地存储

## 测试考虑

### 消息处理器测试
- 使用有效/无效数据测试每种消息类型
- 验证错误处理和响应
- 检查并发请求处理

### 定时任务测试
- 验证定时任务的创建和触发
- 测试清理操作不会损坏数据
- 检查通知权限处理

### 安装测试
- 测试全新安装流程
- 验证更新迁移
- 检查默认设置初始化

## 调试

### 启用详细日志
服务工作线程包含全面的日志记录：
- `[Background]` - 主要服务事件
- `[MessageHandler]` - 消息处理
- `[AlarmHandler]` - 定时任务

### 查看服务工作线程
1. 访问 `chrome://extensions`
2. 启用开发者模式
3. 点击扩展下方的"Service Worker"
4. 查看控制台日志

### 检查消息
所有消息都会记录类型和数据用于调试。

## 未来改进

- [ ] 添加离线模式支持
- [ ] 实现请求队列以进行速率限制
- [ ] 添加使用模式分析（可选）
- [ ] 词汇云同步支持
- [ ] 高级错误恢复和重试逻辑
